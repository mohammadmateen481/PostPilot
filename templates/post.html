{% extends "base.html" %}

{% block title %}{{ post.title }} - BlogSpace{% endblock %}

{% block content %}
<article class="post-detail">
    <!-- Post Header -->
    <header class="post-header">
        <div class="post-meta-info">
            <a href="{{ url_for('index', category=post.category) }}" class="post-category">
                {{ post.category|title }}
            </a>
            <span class="post-date">
                {{ post.published_at.strftime('%B %d, %Y') }}
            </span>
            <span class="reading-time">
                <i class="far fa-clock"></i> {{ post.reading_time }} min read
            </span>
        </div>
        
        <h1 class="post-title">{{ post.title }}</h1>
        
        <div class="author-info">
            <img src="{{ url_for('static', filename='uploads/' + post.author.profile_image) if post.author.profile_image else url_for('static', filename='images/default-avatar.png') }}" 
                 alt="{{ post.author.username }}" class="author-avatar">
            <div>
                <a href="#" class="author-name">{{ post.author.username }}</a>
                <div class="author-bio">{{ post.author.bio|truncate(100) }}</div>
            </div>
            <button class="btn btn-outline follow-btn">Follow</button>
        </div>
    </header>

    <!-- Cover Image -->
    {% if post.cover_image %}
    <div class="post-cover-container">
        <img src="{{ url_for('static', filename='uploads/' + post.cover_image) }}" 
             alt="{{ post.title }}" class="post-cover">
    </div>
    {% endif %}

    <!-- Post Content -->
    <div class="post-content">
        {{ post.content|safe }}
    </div>

    <!-- Tags -->
    {% if post.tags %}
    <div class="post-tags">
        {% for tag in post.tags.split(',') %}
        <a href="{{ url_for('search') }}?q={{ tag.strip() }}" class="tag">{{ tag.strip() }}</a>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Post Actions -->
    <div class="post-actions">
        <div class="action-left">
            <button class="like-btn {% if user_liked %}liked{% endif %}" data-post-id="{{ post.id }}">
                <i class="{% if user_liked %}fas{% else %}far{% endif %} fa-heart"></i>
                <span class="like-count">{{ post.likes|length }}</span>
            </button>
            
            <button class="action-btn" onclick="sharePost()">
                <i class="fas fa-share"></i> Share
            </button>
            
            <button class="action-btn" onclick="bookmarkPost()">
                <i class="far fa-bookmark"></i> Save
            </button>
        </div>
        
        <div class="action-right">
            <span class="post-stats">
                <i class="far fa-eye"></i> {{ post.views }} views
                <i class="far fa-comment"></i> {{ post.comments|length }} comments
            </span>
        </div>
    </div>

    <!-- Author Bio Card -->
    <div class="author-card">
        <img src="{{ url_for('static', filename='uploads/' + post.author.profile_image) if post.author.profile_image else url_for('static', filename='images/default-avatar.png') }}" 
             alt="{{ post.author.username }}" class="author-avatar-large">
        <div class="author-details">
            <h3>Written by {{ post.author.username }}</h3>
            <p>{{ post.author.bio or "No bio yet." }}</p>
            <div class="author-stats">
                <span>{{ post.author.posts|length }} posts</span>
                <span>{{ post.author.followers|length }} followers</span>
            </div>
            <button class="btn btn-outline follow-btn">Follow</button>
        </div>
    </div>

    <!-- Comments Section -->
    <section class="comments-section" id="comments">
        <h2>Comments ({{ post.comments|length }})</h2>
        
        {% if current_user.is_authenticated %}
        <form method="POST" action="{{ url_for('add_comment', slug=post.slug) }}" class="comment-form">
            {{ form.hidden_tag() }}
            <div class="form-group">
                {{ form.content.label(class="form-label") }}
                {{ form.content(class="form-control", rows=3, placeholder="Share your thoughts...") }}
            </div>
            <button type="submit" class="btn btn-primary">Post Comment</button>
        </form>
        {% else %}
        <div class="login-prompt">
            <p>Please <a href="{{ url_for('login') }}">sign in</a> to leave a comment.</p>
        </div>
        {% endif %}

        <!-- Comments List -->
        <div class="comments-list">
            {% for comment in comments %}
            <div class="comment {% if comment.parent_id %}comment-reply{% endif %}" id="comment-{{ comment.id }}">
                <div class="comment-header">
                    <div class="comment-author">
                        <img src="{{ url_for('static', filename='uploads/' + comment.commenter.profile_image) if comment.commenter.profile_image else url_for('static', filename='images/default-avatar.png') }}" 
                             alt="{{ comment.commenter.username }}" class="comment-avatar">
                        <div>
                            <strong>{{ comment.commenter.username }}</strong>
                            <span class="comment-time">{{ comment.created_at|time_ago }}</span>
                        </div>
                    </div>
                    {% if current_user.id == comment.user_id or current_user.is_admin() %}
                    <form action="{{ url_for('delete_comment', comment_id=comment.id) }}" method="POST" class="comment-actions">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn-icon" title="Delete comment">
                            <i class="fas fa-trash"></i>
                        </button>
                    </form>
                    {% endif %}
                </div>
                <div class="comment-content">
                    {{ comment.content }}
                </div>
                {% if current_user.is_authenticated %}
                <button class="reply-btn" data-comment-id="{{ comment.id }}">
                    <i class="fas fa-reply"></i> Reply
                </button>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </section>

    <!-- Similar Posts -->
    {% if similar_posts %}
    <section class="similar-posts">
        <h2>More from {{ post.category|title }}</h2>
        <div class="posts-grid">
            {% for similar_post in similar_posts %}
            <article class="post-card">
                <div class="post-meta">
                    <h3><a href="{{ url_for('view_post', slug=similar_post.slug) }}">{{ similar_post.title }}</a></h3>
                    <p>{{ similar_post.excerpt|truncate(150) }}</p>
                    <div class="post-stats">
                        <span>{{ similar_post.published_at.strftime('%b %d') }}</span>
                        <span>{{ similar_post.views }} views</span>
                    </div>
                </div>
            </article>
            {% endfor %}
        </div>
    </section>
    {% endif %}
</article>

<!-- Share Modal -->
<div class="modal" id="shareModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Share this post</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            <div class="share-buttons">
                <button class="share-btn twitter" onclick="shareToTwitter()">
                    <i class="fab fa-twitter"></i> Twitter
                </button>
                <button class="share-btn facebook" onclick="shareToFacebook()">
                    <i class="fab fa-facebook"></i> Facebook
                </button>
                <button class="share-btn linkedin" onclick="shareToLinkedIn()">
                    <i class="fab fa-linkedin"></i> LinkedIn
                </button>
                <button class="share-btn copy-link" onclick="copyPostLink()">
                    <i class="fas fa-link"></i> Copy Link
                </button>
            </div>
            <div class="share-url">
                <input type="text" value="{{ url_for('view_post', slug=post.slug, _external=True) }}" readonly>
                <button class="btn btn-sm" onclick="copyPostLink()">Copy</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Time ago function
function timeAgo(date) {
    const seconds = Math.floor((new Date() - new Date(date)) / 1000);
    const intervals = {
        year: 31536000,
        month: 2592000,
        week: 604800,
        day: 86400,
        hour: 3600,
        minute: 60
    };
    
    for (const [unit, secondsInUnit] of Object.entries(intervals)) {
        const interval = Math.floor(seconds / secondsInUnit);
        if (interval >= 1) {
            return `${interval} ${unit}${interval === 1 ? '' : 's'} ago`;
        }
    }
    return 'Just now';
}

// Update all time ago elements
document.querySelectorAll('.comment-time').forEach(element => {
    if (element.textContent.includes('ago')) return;
    const date = new Date(element.textContent);
    element.textContent = timeAgo(date);
});

// Reply functionality
document.querySelectorAll('.reply-btn').forEach(button => {
    button.addEventListener('click', function() {
        const commentId = this.dataset.commentId;
        const commentElement = document.getElementById(`comment-${commentId}`);
        
        // Remove any existing reply form
        const existingForm = commentElement.querySelector('.reply-form');
        if (existingForm) {
            existingForm.remove();
            return;
        }
        
        // Create reply form
        const form = document.createElement('form');
        form.className = 'reply-form';
        form.innerHTML = `
            <div class="form-group">
                <textarea class="form-control" rows="2" placeholder="Write your reply..."></textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-sm btn-outline cancel-reply">Cancel</button>
                <button type="submit" class="btn btn-sm btn-primary">Reply</button>
            </div>
        `;
        
        // Insert after the button
        this.after(form);
        
        // Focus on textarea
        form.querySelector('textarea').focus();
        
        // Cancel button
        form.querySelector('.cancel-reply').addEventListener('click', () => form.remove());
        
        // Submit handler
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const content = form.querySelector('textarea').value.trim();
            
            if (content) {
                try {
                    const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
                    const response = await fetch(`{{ url_for('add_comment', slug=post.slug) }}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': csrfToken
                        },
                        body: new URLSearchParams({
                            'content': content,
                            'parent_id': commentId
                        })
                    });
                    
                    if (response.ok) {
                        location.reload();
                    }
                } catch (error) {
                    console.error('Error posting reply:', error);
                }
            }
        });
    });
});

// Share post functionality
function sharePost() {
    document.getElementById('shareModal').style.display = 'block';
}

function closeShareModal() {
    document.getElementById('shareModal').style.display = 'none';
}

function shareToTwitter() {
    const url = encodeURIComponent(window.location.href);
    const text = encodeURIComponent("{{ post.title }}");
    window.open(`https://twitter.com/intent/tweet?url=${url}&text=${text}`, '_blank');
}

function shareToFacebook() {
    const url = encodeURIComponent(window.location.href);
    window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank');
}

function shareToLinkedIn() {
    const url = encodeURIComponent(window.location.href);
    window.open(`https://www.linkedin.com/shareArticle?url=${url}`, '_blank');
}

function copyPostLink() {
    const urlInput = document.querySelector('.share-url input');
    urlInput.select();
    document.execCommand('copy');
    
    // Show copied message
    const copyBtn = document.querySelector('.share-url .btn');
    const originalText = copyBtn.textContent;
    copyBtn.textContent = 'Copied!';
    copyBtn.classList.add('btn-success');
    
    setTimeout(() => {
        copyBtn.textContent = originalText;
        copyBtn.classList.remove('btn-success');
    }, 2000);
}

// Close modal when clicking outside
document.addEventListener('click', (e) => {
    const modal = document.getElementById('shareModal');
    if (e.target === modal) {
        closeShareModal();
    }
});

document.querySelector('.close-modal').addEventListener('click', closeShareModal);
</script>
{% endblock %}