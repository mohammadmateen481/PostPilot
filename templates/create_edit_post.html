{% extends "base.html" %}

{% block title %}{{ title }} - BlogSpace{% endblock %}

{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/editor.css') }}">
{% endblock %}

{% block content %}
<div class="container">
    <div class="editor-container-full">
        <h1>{{ title }}</h1>
        
        <form method="POST" action="" enctype="multipart/form-data">
            {{ form.hidden_tag() }}
            
            <div class="form-group">
                {{ form.title.label(class="form-label") }}
                {{ form.title(class="form-control", placeholder="Enter post title") }}
                <div class="form-text">A good title is clear and descriptive.</div>
            </div>
            
            <div class="form-group">
                {{ form.excerpt.label(class="form-label") }}
                {{ form.excerpt(class="form-control", placeholder="Brief summary of your post (optional)", rows=3) }}
                <div class="form-text">This will appear in post previews.</div>
            </div>
            
            <div class="form-row">
                <div class="form-group half">
                    {{ form.category.label(class="form-label") }}
                    {{ form.category(class="form-control") }}
                </div>
                
                <div class="form-group half">
                    {{ form.tags.label(class="form-label") }}
                    {{ form.tags(class="form-control", placeholder="technology, programming, web") }}
                    <div class="form-text">Separate tags with commas</div>
                </div>
            </div>
            
            <div class="form-group">
                {{ form.cover_image.label(class="form-label") }}
                {{ form.cover_image(class="form-control-file") }}
                <div class="form-text">Recommended size: 1200x800 pixels</div>
                
                {% if post and post.cover_image %}
                <div class="current-image">
                    <img src="{{ url_for('static', filename='uploads/' + post.cover_image) }}" 
                         alt="Current cover" style="max-width: 300px; margin-top: 1rem;">
                </div>
                {% endif %}
            </div>
            
            <div class="form-group">
                {{ form.content.label(class="form-label") }}
                <div class="editor-toolbar">
                    <button type="button" class="editor-btn" data-command="bold" title="Bold">
                        <i class="fas fa-bold"></i>
                    </button>
                    <button type="button" class="editor-btn" data-command="italic" title="Italic">
                        <i class="fas fa-italic"></i>
                    </button>
                    <button type="button" class="editor-btn" data-command="underline" title="Underline">
                        <i class="fas fa-underline"></i>
                    </button>
                    <div class="toolbar-divider"></div>
                    <button type="button" class="editor-btn" data-command="insertUnorderedList" title="Bullet List">
                        <i class="fas fa-list-ul"></i>
                    </button>
                    <button type="button" class="editor-btn" data-command="insertOrderedList" title="Numbered List">
                        <i class="fas fa-list-ol"></i>
                    </button>
                    <div class="toolbar-divider"></div>
                    <button type="button" class="editor-btn" data-command="createLink" title="Insert Link">
                        <i class="fas fa-link"></i>
                    </button>
                    <button type="button" class="editor-btn" data-command="unlink" title="Remove Link">
                        <i class="fas fa-unlink"></i>
                    </button>
                    <div class="toolbar-divider"></div>
                    <button type="button" class="editor-btn" data-command="formatBlock" data-value="h2" title="Heading 2">
                        H2
                    </button>
                    <button type="button" class="editor-btn" data-command="formatBlock" data-value="h3" title="Heading 3">
                        H3
                    </button>
                    <button type="button" class="editor-btn" data-command="formatBlock" data-value="p" title="Paragraph">
                        P
                    </button>
                    <div class="toolbar-divider"></div>
                    <button type="button" class="editor-btn" data-command="undo" title="Undo">
                        <i class="fas fa-undo"></i>
                    </button>
                    <button type="button" class="editor-btn" data-command="redo" title="Redo">
                        <i class="fas fa-redo"></i>
                    </button>
                </div>
                {{ form.content(class="editor-content", rows=20) }}
                <div class="editor-stats">
                    <span class="word-count">0 words</span>
                    <span class="char-count">0 characters</span>
                </div>
            </div>
            
            <div class="form-group">
                <div class="form-check">
                    {{ form.is_published(class="form-check-input") }}
                    {{ form.is_published.label(class="form-check-label") }}
                </div>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-save"></i> {{ 'Update' if post else 'Publish' }} Post
                </button>
                
                {% if post %}
                <a href="{{ url_for('view_post', slug=post.slug) }}" class="btn btn-outline">
                    <i class="fas fa-eye"></i> Preview
                </a>
                {% endif %}
                
                <a href="{{ url_for('dashboard') }}" class="btn btn-outline">
                    <i class="fas fa-times"></i> Cancel
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Rich text editor functionality
const editor = document.querySelector('.editor-content');
const editorContent = document.createElement('div');
editorContent.className = 'editor-content-editable';
editorContent.contentEditable = true;
editorContent.innerHTML = editor.value || '<p>Start writing your amazing post here...</p>';

// Replace textarea with contenteditable div
editor.style.display = 'none';
editor.parentNode.insertBefore(editorContent, editor.nextSibling);

// Update word and character count
function updateEditorStats() {
    const text = editorContent.textContent;
    const words = text.trim().split(/\s+/).filter(word => word.length > 0);
    const characters = text.length;
    
    document.querySelector('.word-count').textContent = `${words.length} words`;
    document.querySelector('.char-count').textContent = `${characters} characters`;
}

editorContent.addEventListener('input', updateEditorStats);
updateEditorStats();

// Toolbar functionality
document.querySelectorAll('.editor-btn').forEach(button => {
    button.addEventListener('click', function(e) {
        e.preventDefault();
        const command = this.dataset.command;
        const value = this.dataset.value;
        
        editorContent.focus();
        
        if (command === 'createLink') {
            const url = prompt('Enter URL:');
            if (url) {
                document.execCommand(command, false, url);
            }
        } else if (value) {
            document.execCommand(command, false, value);
        } else {
            document.execCommand(command, false, null);
        }
        
        updateEditorStats();
    });
});

// Sync content to textarea before form submit
const form = document.querySelector('form');
form.addEventListener('submit', function() {
    editor.value = editorContent.innerHTML;
});

// Image upload handler
const imageUpload = document.createElement('input');
imageUpload.type = 'file';
imageUpload.accept = 'image/*';
imageUpload.style.display = 'none';

document.body.appendChild(imageUpload);

// Insert image button
const insertImageBtn = document.createElement('button');
insertImageBtn.type = 'button';
insertImageBtn.className = 'editor-btn';
insertImageBtn.innerHTML = '<i class="fas fa-image"></i>';
insertImageBtn.title = 'Insert Image';
insertImageBtn.addEventListener('click', () => imageUpload.click());

document.querySelector('.editor-toolbar').appendChild(insertImageBtn);

imageUpload.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        // Create a FormData object to upload the image
        const formData = new FormData();
        formData.append('image', file);
        
        // Add CSRF token
        const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
        
        // Upload image to server
        fetch('/upload-image', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.url) {
                // Insert image into editor
                document.execCommand('insertImage', false, data.url);
            }
        })
        .catch(error => {
            console.error('Error uploading image:', error);
            alert('Failed to upload image');
        });
    }
});

// Auto-save draft
let saveTimeout;
function autoSaveDraft() {
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(() => {
        const draft = {
            title: document.getElementById('title').value,
            content: editorContent.innerHTML,
            excerpt: document.getElementById('excerpt').value,
            category: document.getElementById('category').value,
            tags: document.getElementById('tags').value
        };
        
        localStorage.setItem('post_draft', JSON.stringify(draft));
        console.log('Draft auto-saved');
    }, 2000);
}

// Listen for changes
document.getElementById('title').addEventListener('input', autoSaveDraft);
document.getElementById('excerpt').addEventListener('input', autoSaveDraft);
document.getElementById('category').addEventListener('change', autoSaveDraft);
document.getElementById('tags').addEventListener('input', autoSaveDraft);
editorContent.addEventListener('input', autoSaveDraft);

// Load draft on page load
window.addEventListener('load', function() {
    const draft = localStorage.getItem('post_draft');
    if (draft && !editor.value) {
        if (confirm('You have a saved draft. Load it?')) {
            const data = JSON.parse(draft);
            document.getElementById('title').value = data.title || '';
            editorContent.innerHTML = data.content || '<p>Start writing...</p>';
            document.getElementById('excerpt').value = data.excerpt || '';
            document.getElementById('category').value = data.category || '';
            document.getElementById('tags').value = data.tags || '';
            updateEditorStats();
        }
    }
});

// Clear draft when publishing
form.addEventListener('submit', function() {
    localStorage.removeItem('post_draft');
});
</script>
{% endblock %}